<!doctype html>
<html lang="zh-CN">
<head>
  <link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#3f86a5">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>è¿™ä¸ªä»·ï¼Œå€¼ä¸å€¼ â€” Worth It Or Not</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#fff9ef;
      --board:#fff8ed;
      --accent:#3f86a5;
      --accent-2:#2f6f93;
      --muted:#88907f;
      --card:#ffffff;
    }
    html,body{height:100%;background:var(--bg);font-family:Inter,system-ui,Segoe UI, Roboto, 'Noto Sans SC', 'PingFang SC','Hiragino Sans',sans-serif}
    .container{max-width:420px;margin:0 auto;padding:25px}
    header{display:flex;align-items:flex-start;justify-content:space-between}
    h1{font-size:25px;color:var(--accent);line-height:0.9;font-weight:550}
    .subtitle{color:var(--accent);opacity:0.85;font-size:20px;margin-top:6px}
    .board-wrap{margin-top:10px;background:linear-gradient(#fffaf2,#fff7ec);border-radius:34px;padding:18px;border:4px solid #00000088;box-shadow:18px 18px 0 rgba(63,134,165,0.9);}
    .shops-grid{display:flex;flex-wrap:wrap;gap:18px;align-items:flex-start}
    .shop-pill{width:88px;height:88px;border-radius:18px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:transparent}
    .shop-icon{width:64px;height:64px;border-radius:9999px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:32px;border:6px solid rgba(255,255,255,0.6)}
    .shop-name{margin-top:8px;font-size:14px;color:#6e6e6e}
    .add-shop-btn{padding:6px 14px;border-radius:22px;background:var(--board);border:4px solid #00000044;box-shadow:6px 6px 0 var(--accent-2);color:var(--accent);font-weight:14px}
    .search-pill{display:flex;align-items:center;background:var(--board);border-radius:34px;padding:12px 14px;margin-top:18px;border:6px solid #00000022;box-shadow:12px 12px 0 rgba(63,134,165,0.85)}
    .search-input{flex:1;border:none;background:transparent;outline:none;font-size:18px;color:var(--accent)}
    .search-icon{width:44px;height:44px;border-radius:9999px;display:flex;align-items:center;justify-content:center;border:4px solid rgba(0,0,0,0.08)}
    .tags-row{display:flex;gap:10px;margin-top:12px;overflow:auto;padding-bottom:6px}
    .tag-pill{display:inline-flex;align-items:center;justify-content:center;height:40px;min-width:96px;padding:0 12px;border-radius:999px;border:4px solid var(--accent-2);background:var(--board);color:var(--accent);font-weight:700;font-size:14px;white-space:nowrap;flex:0 0 auto;box-sizing:border-box;}
    .result-area{margin-top:16px;background:var(--accent);border-radius:24px;padding:18px;min-height:320px;color:white}
    .product-card{background:var(--board);border-radius:18px;padding:14px;display:flex;align-items:center;justify-content:space-between;color:var(--accent-2);box-shadow: inset 0 -6px 0 rgba(0,0,0,0.04);}
    .prod-left{display:flex;gap:12px;align-items:center}
    .prod-icon{width:64px;height:64px;border-radius:999px;border:6px solid rgba(255,255,255,0.6);display:flex;align-items:center;justify-content:center;font-weight:700}
    .prod-meta{font-weight:700}
    .prod-extra{font-size:13px;color:var(--muted);margin-top:2px}
    .prod-price{font-size:24px;font-weight:700}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:#cfc6b3;border-radius:18px;padding:18px;width:92%;max-width:420px}
    .modal h3{font-size:28px;color:#6b614d}
    .input{width:100%;padding:12px;border-radius:12px;border:none;margin-top:12px}
    .color-grid{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .color-swatch{width:40px;height:40px;border-radius:999px;border:3px solid rgba(0,0,0,0.05)}
    .modal .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:14px}
    .btn{padding:8px 12px;border-radius:10px}
    .btn-primary{background:var(--accent);color:white}
    .btn-alt{background:white}
    @media(min-width:520px){ .container{max-width:480px} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>è¿™ä¸ªä»·ï¼Œå€¼ä¸å€¼</h1>
        <div class="subtitle">Worth It Or Not</div>
      </div>
      <div style="display:flex;flex-direction:column; gap:8px;align-items:flex-end">
        <div style="display:flex;gap:8px">
          <button id="importBtn" class="add-shop-btn">â¬‡ å¯¼å…¥</button>
          <button id="exportBtn" class="add-shop-btn">â¬† å¯¼å‡º</button>
        </div>
        <button id="openAddShop" class="add-shop-btn">æ·»åŠ å•†åº—</button>
      </div>
    </header>

    <section class="board-wrap" aria-label="å•†åº—é¢æ¿">
      <div class="shops-grid" id="shopsGrid"></div>
    </section>

    <div class="search-pill">
      <input id="globalSearch" class="search-input" placeholder="æœç´¢å•†å“" />
      <div class="search-icon">ğŸ”</div>
    </div>

    <div class="tags-row" id="tagRow"></div>

    <div class="result-area" id="resultArea">
      <div id="resultList"></div>
    </div>
  </div>

  <div id="modalRoot"></div>

  <script>
    // å•æ–‡ä»¶åº”ç”¨ï¼šåœ¨ä½ ç°æœ‰åŸºç¡€ä¸Šå¢åŠ â€œæ¯å•ä½ä»·æ ¼â€è‡ªåŠ¨æ¢ç®—ä¸æŒ‰å•ä½ä»·æ’åºåŠŸèƒ½
    const COLORS = [
      '#D8F3DC','#BEE6D6','#FDE2E4','#FAD8D6','#FFF1C9','#F7E9D7','#E8F6EF','#F6E6F0','#E6F0F8','#DFF3E3','#FFF4E0','#E9F4FA'
    ];

    function uid(prefix='id'){return prefix+Math.random().toString(36).slice(2,9)}
    function today(){ const d=new Date(); return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear(); }

    const modalRoot = document.getElementById('modalRoot');
    let state = loadData(); if(!state.products) state.products = {};
    if(!state.shops) state.shops = [];

    // ---------- helpers for unit conversion & unit price ----------
    // æ”¯æŒå•ä½ï¼š g, kg, ml, l
    // convertToBase è¿”å› {amount: Number, baseUnit: 'g'|'ml'|null}
    function convertToBase(capVal, capUnit){
      if(capVal === null || capVal === undefined) return {amount: null, baseUnit: null};
      const v = parseFloat(String(capVal).replace(/,/g,''));
      if(!isFinite(v)) return {amount: null, baseUnit: null};
      const u = (capUnit || '').toLowerCase();
      if(u === 'g') return {amount: v, baseUnit: 'g'};
      if(u === 'kg') return {amount: v * 1000, baseUnit: 'g'};
      if(u === 'ml') return {amount: v, baseUnit: 'ml'};
      if(u === 'l') return {amount: v * 1000, baseUnit: 'ml'};
      return {amount: null, baseUnit: null};
    }

    // getUnitPrice(product) -> { value: Number|null, baseUnit: 'g'|'ml'|null, label: string|null }
    function getUnitPrice(prod){
      if(!prod) return {value:null, baseUnit:null, label:null};
      const {amount, baseUnit} = convertToBase(prod.capacityVal, prod.capacityUnit);
      if(!amount || !baseUnit) return {value:null, baseUnit:null, label:null};
      const val = (Number(prod.price)||0) / amount; // RM per baseUnit
      // æ ¼å¼åŒ–ä¿ç•™ 5 ä½å°æ•°ä»¥å†…æ˜¾ç¤ºåˆé€‚çš„ä½æ•°
      const disp = val >= 0.1 ? val.toFixed(2) : val >= 0.01 ? val.toFixed(3) : val >= 0.001 ? val.toFixed(4) : val.toFixed(5);
      return { value: val, baseUnit, label: `RM${disp} / ${baseUnit}` };
    }

    // ---------- UI / rendering helpers ----------
    const shopsGrid = document.getElementById('shopsGrid');
    function renderShops(){ shopsGrid.innerHTML=''; if(state.shops.length===0){ shopsGrid.innerHTML='<div style="color:#9aa6a8;font-weight:600">è¿˜æ²¡æœ‰å•†åº—ï¼Œç‚¹å‡»å³ä¸Šæ·»åŠ </div>'; return; }
      state.shops.forEach(s=>{ const el = document.createElement('div'); el.className='shop-pill';
        const icon = document.createElement('div'); icon.className='shop-icon'; icon.textContent = (s.name||'?').trim().charAt(0).toUpperCase(); icon.style.background = s.color; icon.style.color = getContrastColor(s.color);
        const name = document.createElement('div'); name.className='shop-name'; name.textContent = s.name;
        const gear = document.createElement('button'); gear.textContent='âš™ï¸'; gear.style.position='absolute'; gear.style.marginLeft='70px'; gear.style.marginTop='6px'; gear.style.border='none'; gear.style.background='transparent';
        gear.addEventListener('click',(e)=>{ e.stopPropagation(); openManageShop(s.id); });
        el.appendChild(icon); el.appendChild(name);
        el.addEventListener('click',()=> openShopPage(s.id));
        el.appendChild(gear);
        shopsGrid.appendChild(el);
      }); }

    function getContrastColor(hex){ if(!hex) return '#000'; const c = hex.replace('#',''); const r = parseInt(c.substring(0,2),16); const g = parseInt(c.substring(2,4),16); const b = parseInt(c.substring(4,6),16); const yiq = (r*299 + g*587 + b*114)/1000; return yiq >= 128 ? '#2f6f93' : '#fff'; }

    document.getElementById('openAddShop').addEventListener('click', ()=>{
      showModal(`<div class='modal'>
        <h3>æ·»åŠ å•†åº—</h3>
        <input id='newShopName' class='input' placeholder='å•†åº—åç§°' />
        <div style='margin-top:8px;font-weight:600'>é€‰æ‹©å›¾æ ‡é¢œè‰²</div>
        <div class='color-grid' id='colorGrid'></div>
        <div class='actions'>
          <button id='cancelAdd' class='btn btn-alt'>å–æ¶ˆ</button>
          <button id='confirmAdd' class='btn btn-primary'>æ·»åŠ </button>
        </div>
      </div>`);
      const grid = document.getElementById('colorGrid'); let picked = COLORS[0];
      COLORS.forEach(c=>{ const s = document.createElement('button'); s.className='color-swatch'; s.style.background=c; s.addEventListener('click',()=>{ picked=c; document.querySelectorAll('.color-swatch').forEach(x=>x.style.outline='none'); s.style.outline='3px solid rgba(0,0,0,0.12)'; }); grid.appendChild(s); });
      document.getElementById('confirmAdd').addEventListener('click', ()=>{ const name = document.getElementById('newShopName').value.trim(); if(!name){ alert('è¯·è¾“å…¥å•†åº—åç§°'); return; } addShop(name,picked); closeModal(); });
      document.getElementById('cancelAdd').addEventListener('click', closeModal);
    });

    function addShop(name,color){ const s = {id:uid('shop_'), name, color}; state.shops.push(s); saveData(); renderShops(); }

    function openManageShop(id){ const shop = state.shops.find(x=>x.id===id); if(!shop) return; showModal(`<div class='modal'>
      <h3>ç®¡ç†ï¼š ${escapeHtml(shop.name)}</h3>
      <input id='editName' class='input' value='${escapeHtml(shop.name)}' />
      <div style='margin-top:8px;font-weight:600'>å›¾æ ‡é¢œè‰²</div>
      <div class='color-grid' id='editColorGrid'></div>
      <div class='actions'>
        <button id='delShopBtn' class='btn btn-alt'>åˆ é™¤å•†åº—</button>
        <button id='saveShopBtn' class='btn btn-primary'>ä¿å­˜</button>
      </div>
    </div>`);
      const grid = document.getElementById('editColorGrid'); let picked = shop.color; COLORS.forEach(c=>{ const s=document.createElement('button'); s.className='color-swatch'; s.style.background=c; if(c===shop.color) s.style.outline='3px solid rgba(0,0,0,0.12)'; s.addEventListener('click',()=>{ picked=c; document.querySelectorAll('#editColorGrid .color-swatch').forEach(x=>x.style.outline='none'); s.style.outline='3px solid rgba(0,0,0,0.12)'; }); grid.appendChild(s); });
      document.getElementById('saveShopBtn').addEventListener('click', ()=>{ const nm = document.getElementById('editName').value.trim(); if(!nm){ alert('åç§°ä¸èƒ½ä¸ºç©º'); return; } shop.name = nm; shop.color = picked; saveData(); renderShops(); renderTags(); closeModal(); });
      document.getElementById('delShopBtn').addEventListener('click', ()=>{ if(confirm('ç¡®è®¤åˆ é™¤è¯¥å•†åº—åŠå…¶æ‰€æœ‰å•†å“ï¼Ÿ')){ state.shops = state.shops.filter(s=>s.id!==id); for(const k in state.products) if(state.products[k].shopId===id) delete state.products[k]; saveData(); renderShops(); renderTags(); renderResults(); closeModal(); }});
    }

    function openShopPage(shopId){ const shop = state.shops.find(s=>s.id===shopId); if(!shop) return;
      showModal(`<div class='modal'>
        <div style='display:flex;align-items:center;justify-content:space-between'>
          <button id='closeShopModal' style='background:transparent;border:none;font-size:26px'>â†</button>
          <div style='flex:1;text-align:center;font-weight:700;font-size:18px'>${escapeHtml(shop.name)}</div>
          <div style='width:36px'></div>
        </div>
        <div style='display:flex;justify-content:flex-end;margin-top:8px'><button id='addProdBtn' class='btn btn-primary'>æ·»åŠ å•†å“</button></div>
        <div id='prodList' style='margin-top:12px;max-height:60vh;overflow:auto'></div>
      </div>`);
      document.getElementById('addProdBtn').addEventListener('click', ()=> openAddProductModal(shopId));
      const closeBtn = document.getElementById('closeShopModal'); if(closeBtn) closeBtn.addEventListener('click', closeModal);
      renderProductList(shopId);
    }

    function renderProductList(shopId){
      const wrap = document.getElementById('prodList'); wrap.innerHTML=''; 
      const prods = Object.values(state.products).filter(p=>p.shopId===shopId);
      if(prods.length===0){ wrap.innerHTML='<div style="color:#6b6b6b">æ­¤åº—æš‚æ— å•†å“</div>'; return; }
      prods.forEach(p=>{
        const div=document.createElement('div'); div.className='product-card'; div.style.marginBottom='12px';
        const unitInfo = getUnitPrice(p);
        const unitHtml = unitInfo.label ? `<div style="font-size:12px;color:${'#6b6b6b'};margin-top:4px">${unitInfo.label}</div>` : '';
        div.innerHTML = `<div class='prod-left'>
          <div class='prod-icon' style='background:${getShopColor(shopId)};color:${getContrastColor(getShopColor(shopId))}'>${escapeHtml(getShopInitial(shopId))}</div>
          <div>
            <div class='prod-meta'>${escapeHtml(p.name)}</div>
            <div class='prod-extra'>${escapeHtml(p.date||'')} Â· ${p.capacityVal?escapeHtml(p.capacityVal+' '+p.capacityUnit):''}</div>
            <div style='margin-top:8px'>${(p.tags||[]).map(t=>`<span class='tag-pill' style='background:var(--board);border:4px solid var(--accent-2);margin-right:6px'>${escapeHtml(t)}</span>`).join('')}</div>
            ${unitHtml}
          </div>
        </div>
        <div style='text-align:right'>
          <div class='prod-price'>RM ${Number(p.price).toFixed(2)}</div>
          <div style='margin-top:10px'><button class='btn btn-alt' data-id='${p.id}' data-action='edit'>ç¼–è¾‘</button></div>
          <div style='font-size:12px;color:var(--muted);margin-top:6px;cursor:pointer' data-action='details' data-id='${p.id}'>æ›´å¤šç»†èŠ‚</div>
        </div>`;
        wrap.appendChild(div);
      });
      wrap.querySelectorAll('[data-action="edit"]').forEach(btn=>btn.addEventListener('click', (e)=> openEditProductModal(e.target.dataset.id)));
      wrap.querySelectorAll('[data-action="details"]').forEach(btn=>btn.addEventListener('click', (e)=> showHistoryModal(e.target.dataset.id)));
    }

    function getShopColor(id){ const s = state.shops.find(x=>x.id===id); return s? s.color:'#ddd'; }
    function getShopInitial(id){ const s = state.shops.find(x=>x.id===id); return s? (s.name||'?').charAt(0).toUpperCase(): '?'; }

    function openAddProductModal(shopId){ 
      showModal(`<div class='modal'>
        <h3>${escapeHtml(getShopName(shopId))}-æ·»åŠ å•†å“</h3>
        <input id='p_name' class='input' placeholder='å•†å“åç§°' />
        <div style='display:flex;gap:8px;margin-top:8px'>
          <div style='display:flex;align-items:center;gap:8px'>RM <input id='p_price' type='number' class='input' style='width:120px' placeholder='0' /></div>
          <div style='display:flex;gap:8px'>
            <input id='p_cap' type='number' class='input' style='width:100px' placeholder='æ•°é‡' />
            <select id='p_unit' class='input' style='width:80px'><option value='g'>g</option><option value='kg'>kg</option><option value='ml'>ml</option><option value='l'>l</option></select>
          </div>
        </div>
        <input id='p_date' class='input' value='${today()}' />
        <input id='p_tags' class='input' placeholder='å‰¯æ ‡ç­¾ï¼Œé€—å·åˆ†éš”' />
        <div style='margin-top:8px;font-size:13px;color:#6b6b6b'>æç¤ºï¼šè®°å½•å®¹é‡å•ä½ï¼ˆg/kg/ml/lï¼‰å¯å¯ç”¨â€œå•ä½ä»·â€æ¯”è¾ƒã€‚</div>
        <div class='actions'><button id='cancelP' class='btn btn-alt'>å–æ¶ˆ</button><button id='saveP' class='btn btn-primary'>ä¿å­˜</button></div>
      </div>`);
      document.getElementById('cancelP').addEventListener('click', closeModal);
      document.getElementById('saveP').addEventListener('click', ()=>{
        const name = document.getElementById('p_name').value.trim(); if(!name){ alert('è¯·è¾“å…¥å•†å“åç§°'); return; }
        const price = parseFloat(document.getElementById('p_price').value)||0;
        const cap = document.getElementById('p_cap').value;
        const unit = document.getElementById('p_unit').value;
        const date = document.getElementById('p_date').value;
        const tags = document.getElementById('p_tags').value.split(',').map(t=>t.trim()).filter(Boolean);
        const p = {id:uid('prod_'), shopId, name, price, capacityVal:cap, capacityUnit:unit, date, tags, history: []};
        state.products[p.id]=p; saveData(); closeModal(); renderTags(); renderResults();
      });
    }

    function openEditProductModal(prodId){ 
      const prod = state.products[prodId]; if(!prod) return;
      if(!Array.isArray(prod.history)) prod.history = [];
      showModal(`<div class='modal'>
        <h3>${escapeHtml(getShopName(prod.shopId))}-ç¼–è¾‘å•†å“</h3>
        <input id='p_name' class='input' value='${escapeHtml(prod.name)}' />
        <div style='display:flex;gap:8px;margin-top:8px'>
          <div style='display:flex;align-items:center;gap:8px'>RM <input id='p_price' type='number' class='input' style='width:120px' value='${Number(prod.price)}' /></div>
          <div style='display:flex;gap:8px'>
            <input id='p_cap' type='number' class='input' style='width:100px' value='${escapeHtml(prod.capacityVal||'')}' />
            <select id='p_unit' class='input' style='width:80px'><option ${prod.capacityUnit==='g'?'selected':''} value='g'>g</option><option ${prod.capacityUnit==='kg'?'selected':''} value='kg'>kg</option><option ${prod.capacityUnit==='ml'?'selected':''} value='ml'>ml</option><option ${prod.capacityUnit==='l'?'selected':''} value='l'>l</option></select>
          </div>
        </div>
        <input id='p_date' class='input' value='${escapeHtml(prod.date||today())}' />
        <input id='p_tags' class='input' value='${escapeHtml((prod.tags||[]).join(','))}' />
        <div style='margin-top:8px;display:flex;gap:8px;justify-content:flex-end'>
          <button id='saveHistoryBtn' class='btn btn-alt'>è®°å½•å†å²ä»·æ ¼</button>
          <button id='viewHistoryBtn' class='btn btn-alt'>å†å²è¯¦æƒ…</button>
        </div>
        <div class='actions'><button id='delP' class='btn btn-alt'>åˆ é™¤</button><button id='saveP' class='btn btn-primary'>ä¿å­˜</button></div>
      </div>`);

      document.getElementById('delP').addEventListener('click', ()=>{ if(confirm('åˆ é™¤è¯¥å•†å“ï¼Ÿ')){ delete state.products[prodId]; saveData(); closeModal(); renderTags(); renderResults(); }});

      document.getElementById('saveHistoryBtn').addEventListener('click', ()=>{
        const price = parseFloat(document.getElementById('p_price').value)||0;
        const date = document.getElementById('p_date').value || today();
        prod.history = prod.history || [];
        prod.history.push({date, price});
        const MAX = 100;
        if(prod.history.length > MAX) prod.history = prod.history.slice(prod.history.length - MAX);
        saveData();
        alert('å†å²ä»·æ ¼å·²ä¿å­˜');
      });

      document.getElementById('viewHistoryBtn').addEventListener('click', ()=> showHistoryModal(prodId));

      document.getElementById('saveP').addEventListener('click', ()=>{ 
        const name=document.getElementById('p_name').value.trim(); if(!name){ alert('è¯·è¾“å…¥å•†å“åç§°'); return; } 
        prod.name=name; prod.price=parseFloat(document.getElementById('p_price').value)||0; prod.capacityVal=document.getElementById('p_cap').value; prod.capacityUnit=document.getElementById('p_unit').value; prod.date=document.getElementById('p_date').value; prod.tags=document.getElementById('p_tags').value.split(',').map(t=>t.trim()).filter(Boolean);
        saveData(); closeModal(); renderTags(); renderResults(); 
      });
    }

    const tagRow = document.getElementById('tagRow'); 
    function renderTags(){ tagRow.innerHTML=''; const s = new Set(); Object.values(state.products).forEach(p=> (p.tags||[]).forEach(t=> s.add(t))); Array.from(s).forEach(t=>{ const b=document.createElement('button'); b.className='tag-pill'; b.textContent=t; b.addEventListener('click', ()=> showByTag(t)); tagRow.appendChild(b); }); }

    function showByTag(tag){ const matched = Object.values(state.products).filter(p=> (p.tags||[]).some(tt=> tt.toLowerCase().includes(tag.toLowerCase())) ); renderGroupedResults(matched); }

    document.getElementById('globalSearch').addEventListener('input',(e)=>{
      const q = e.target.value.trim().toLowerCase();
      if(!q){
        renderResults();
        renderTags();
        return;
      }

      const tags = Array.from(new Set(Object.values(state.products).flatMap(p => p.tags || [])));
      const matchedTag = tags.find(t => t.toLowerCase().includes(q));
      if(matchedTag){
        const row = document.getElementById('tagRow');
        if(row){
          const node = Array.from(row.children).find(ch => (ch.textContent||'').trim() === matchedTag);
          if(node){
            row.prepend(node);
            try{ node.scrollIntoView({behavior:'smooth', inline:'start'}); }catch(e){}
          } else {
            renderTags();
            const newly = Array.from(row.children).find(ch => (ch.textContent||'').trim() === matchedTag);
            if(newly) row.prepend(newly);
          }
        }
      }

      const matchedProducts = Object.values(state.products).filter(p => {
        const nameMatch = (p.name||'').toLowerCase().includes(q);
        const tagMatch = (p.tags||[]).some(t => t.toLowerCase().includes(q));
        return nameMatch || tagMatch;
      });

      matchedProducts.sort((a,b) => {
        // å¦‚æœåœ¨åˆ†ç»„é‡Œä½¿ç”¨çš„æ’åºéœ€è¦æŒ‰å•ä½ä»·æ’åºï¼Œä¼šåœ¨ renderGroupedResults å†…åšæ›´ç²¾ç»†çš„å†³å®š
        return (Number(a.price)||0) - (Number(b.price)||0);
      });

      renderGroupedResults(matchedProducts);
    });

    function renderGroupedResults(list){ 
      const wrap = document.getElementById('resultList'); wrap.innerHTML=''; if(list.length===0){ wrap.innerHTML='<div style="color:#d6eef6;font-weight:600">æ²¡æœ‰åŒ¹é…</div>'; return; }
      list.sort((a,b)=>a.price-b.price);
      const groups = {};
      list.forEach(p=>{ const k = (p.name||'').toLowerCase(); (groups[k] = groups[k]||[]).push(p); });
      Object.values(groups).forEach(arr=>{ 
        const title = document.createElement('div'); title.style.color = '#f6fbfe';
 title.style.fontWeight='700'; title.style.marginTop='8px'; title.style.marginBottom='8px'; title.textContent = arr[0].name; wrap.appendChild(title);

        // å†³å®šè¯¥ç»„æ˜¯å¦ç”¨å•ä½ä»·æ’åºï¼šæ”¶é›†ä¸­æœ‰å•ä½ä»·çš„æ¡ç›®çš„ baseUnit é›†åˆ
        const baseUnits = new Set(arr.map(p=> getUnitPrice(p).baseUnit).filter(Boolean));
        let useUnitSort = false;
        let commonUnit = null;
        if(baseUnits.size === 1){ useUnitSort = true; commonUnit = Array.from(baseUnits)[0]; }

        if(useUnitSort){
          // è‹¥æœ‰å…±åŒåŸºå‡†å•ä½ï¼ˆä¾‹å¦‚å…¨éƒ¨æ˜¯ ml æˆ– å…¨éƒ¨æ˜¯ gï¼‰ï¼ŒæŒ‰å•ä½ä»·æ ¼æ’åºï¼ˆæ— å•ä½ä»·çš„è§†ä¸º+Infinityï¼‰
          arr.sort((a,b)=>{
            const ua = getUnitPrice(a).value; const ub = getUnitPrice(b).value;
            const va = (ua==null)? Infinity : ua;
            const vb = (ub==null)? Infinity : ub;
            return va - vb;
          });
        } else {
          // å›é€€ï¼šæŒ‰æ€»ä»·æ’åº
          arr.sort((a,b)=> (Number(a.price)||0) - (Number(b.price)||0));
        }

        arr.forEach(p=>{
          const unitInfo = getUnitPrice(p);
          const unitHtml = unitInfo.label ? `<div style="font-size:12px;color:#6b6b6b;margin-top:6px">${unitInfo.label}</div>` : '';
          const el = document.createElement('div'); el.className='product-card'; el.style.marginBottom='10px';
          el.innerHTML = `<div class='prod-left'>
            <div class='prod-icon' style='background:${getShopColor(p.shopId)};color:${getContrastColor(getShopColor(p.shopId))}'>${escapeHtml(getShopInitial(p.shopId))}</div>
            <div class='prod-meta' style='color:var(--accent-2)'>${escapeHtml(getShopName(p.shopId))}</div>
            <div class='prod-extra'>${escapeHtml(p.date||'')} Â· ${p.capacityVal?escapeHtml(p.capacityVal+' '+p.capacityUnit):''}</div>
            ${unitHtml}</div>
          </div>
          <div style='text-align:right'>
            <div class='prod-price' style='color:var(--accent-2);font-weight:800'>RM ${Number(p.price).toFixed(2)}</div>
            <div style='margin-top:8px;font-size:12px;color:#6b6b6b;cursor:pointer' data-action='details' data-id='${p.id}'>æ›´å¤šç»†èŠ‚</div>
          </div>`;
          wrap.appendChild(el);
          el.querySelectorAll('[data-action="details"]').forEach(btn=> btn.addEventListener('click', (e)=> showHistoryModal(e.target.dataset.id)));
        });
      });
    }

    function renderResults(){ document.getElementById('resultList').innerHTML=''; }

    // ---------- å†å²æŸ¥çœ‹ä¸ç»˜å›¾ ----------
    function showHistoryModal(prodId){
      const prod = state.products[prodId]; if(!prod) return;
      prod.history = prod.history || [];
      const listHtml = prod.history.map((h, idx) => 
        `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed rgba(0,0,0,0.06)">
           <div style="font-size:14px">${escapeHtml(h.date)} â€” RM ${Number(h.price).toFixed(2)}</div>
           <div style="display:flex;gap:6px">
             <button class="btn btn-alt" data-act="del" data-idx="${idx}">åˆ é™¤</button>
           </div>
         </div>`
      ).join('') || '<div style="color:#6b6b6b">æš‚æ— å†å²è®°å½•</div>';

      showModal(`<div class='modal'>
        <div style='display:flex;align-items:center;justify-content:space-between'>
          <button id='closeHist' style='background:transparent;border:none;font-size:26px'>â†</button>
          <div style='flex:1;text-align:center;font-weight:700;font-size:18px'>${escapeHtml(prod.name)} - å†å²ä»·æ ¼</div>
          <div style='width:36px'></div>
        </div>
        <div style='margin-top:12px'>
          <canvas id='priceChart' width='360' height='160' style='width:100%;border-radius:8px;background:linear-gradient(#fff,#fff8f0)'></canvas>
        </div>
        <div style='margin-top:12px;max-height:240px;overflow:auto'>${listHtml}</div>
        <div style='display:flex;gap:8px;justify-content:flex-end;margin-top:10px'>
          <button id='closeHistBtn' class='btn btn-alt'>å…³é—­</button>
        </div>
      </div>`);

      document.getElementById('closeHist')?.addEventListener('click', closeModal);
      document.getElementById('closeHistBtn')?.addEventListener('click', closeModal);

      const delBtns = modalRoot.querySelectorAll('[data-act="del"]');
      delBtns.forEach(b=> b.addEventListener('click', (e)=>{
        const idx = Number(e.target.dataset.idx);
        if(!Number.isFinite(idx)) return;
        if(confirm('åˆ é™¤è¯¥å†å²æ¡ç›®ï¼Ÿ')){
          prod.history.splice(idx,1); saveData();
          showHistoryModal(prodId);
        }
      }));

      drawPriceChart(prod.history, document.getElementById('priceChart'));
    }

    function drawPriceChart(history, canvas){
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const data = (history||[]).map(h => ({date: h.date, price: Number(h.price)||0}));
      if(data.length === 0){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.font = '14px Arial'; ctx.fillStyle = '#6b6b6b';
        ctx.fillText('æš‚æ— ä»·æ ¼æ•°æ®', 10, 30);
        return;
      }
      const prices = data.map(d=>d.price);
      const minP = Math.min(...prices);
      const maxP = Math.max(...prices);
      const pad = 12;
      const w = canvas.width - pad*2;
      const h = canvas.height - pad*2;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.strokeStyle = 'rgba(0,0,0,0.06)'; ctx.lineWidth=1;
      for(let i=0;i<3;i++){
        const y = pad + i*(h/2);
        ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(pad+w,y); ctx.stroke();
      }
      const stepX = w / Math.max(1, data.length-1);
      const range = (maxP - minP) || 1;
      const points = data.map((d,i)=> {
        const x = pad + i*stepX;
        const y = pad + h - ((d.price - minP)/range)*h;
        return {x,y};
      });
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      for(let i=1;i<points.length;i++) ctx.lineTo(points[i].x, points[i].y);
      ctx.strokeStyle = '#2f6f93'; ctx.lineWidth = 2; ctx.stroke();
      ctx.fillStyle = '#2f6f93';
      points.forEach((pt, i)=>{ ctx.beginPath(); ctx.arc(pt.x, pt.y, 3, 0, Math.PI*2); ctx.fill(); });
      ctx.fillStyle = '#6b6b6b'; ctx.font = '12px Arial';
      ctx.fillText('RM ' + Number(maxP).toFixed(2), 6, pad+10);
      ctx.fillText('RM ' + Number(minP).toFixed(2), 6, pad + h);
      ctx.fillText(data[0].date, pad, canvas.height - 4);
      if(data.length>1) ctx.fillText(data[data.length-1].date, canvas.width - pad - 70, canvas.height - 4);
    }

    function saveData(){ localStorage.setItem('wion_data', JSON.stringify(state)); }
    function loadData(){ try{ return JSON.parse(localStorage.getItem('wion_data'))||{shops:[],products:{}} }catch(e){return {shops:[],products:{}}} }
    function getShopName(id){ const s = state.shops.find(x=>x.id===id); return s? s.name : 'â€”'; }
    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }
    function showModal(inner){ modalRoot.innerHTML = `<div class='modal-backdrop'>${inner}</div>`; }
    function closeModal(){ modalRoot.innerHTML=''; }

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      try{
        const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'wion_backup_'+(new Date()).toISOString().slice(0,10)+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }catch(err){
        showModal(`<div class='modal'>
          <h3>å¯¼å‡º JSONï¼ˆå¤åˆ¶ä¿å­˜ï¼‰</h3>
          <textarea id='exportArea' class='input' style='height:200px'>${escapeHtml(JSON.stringify(state,null,2))}</textarea>
          <div class='actions'><button id='closeExport' class='btn btn-alt'>å…³é—­</button><button id='copyExport' class='btn btn-primary'>å¤åˆ¶</button></div>
        </div>`);
        document.getElementById('copyExport').addEventListener('click', ()=>{ const t = document.getElementById('exportArea'); t.select(); try{ document.execCommand('copy'); alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); }catch(e){ alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶'); } });
        document.getElementById('closeExport').addEventListener('click', closeModal);
      }
    });

    document.getElementById('importBtn').addEventListener('click', ()=>{
      const input=document.createElement('input'); input.type='file'; input.accept='application/json';
      input.addEventListener('change', ()=>{ const f=input.files[0]; if(!f) return; const r=new FileReader(); r.onload=(e)=>{ try{ const obj=JSON.parse(e.target.result); if(obj.shops && obj.products!==undefined){ state=obj; saveData(); renderAll(); alert('å¯¼å…¥æˆåŠŸ'); }else alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®'); }catch(err){ alert('è§£æå¤±è´¥'); }}; r.readAsText(f); }); input.click();
    });

    function renderAll(){ renderShops(); renderTags(); renderResults(); }

    // initial render
    renderAll();

  </script>
</body>
</html>
